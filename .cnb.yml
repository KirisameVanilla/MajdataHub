main:
  push:
    - ifModify:
        - src-tauri/tauri.conf.json
      runner:
        tags: cnb:arch:amd64
        cpus: 8
      docker:
        image: ubuntu:22.04
        volumes:
          # 缓存 Cargo 依赖，加速 Rust 编译
          - /root/.cargo/registry:copy-on-write
          - /root/.cargo/git:copy-on-write
          # 缓存 xwin Windows SDK 下载缓存
          - /root/.xwin-cache:copy-on-write
          # 缓存 pnpm 依赖
          - /root/.local/share/pnpm/store:copy-on-write
      stages:
        - name: 安装系统依赖
          script: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -qq
            apt-get install -y --no-install-recommends \
              curl wget git jq ca-certificates \
              build-essential pkg-config \
              clang llvm lld \
              libssl-dev \
              nsis

        - name: 安装 Rust 工具链与 Windows 交叉编译目标
          script: |
            if ! command -v rustup &>/dev/null; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
            fi
            . "$HOME/.cargo/env"
            rustup target add x86_64-pc-windows-msvc
            # 安装 cargo-xwin 用于 Windows 交叉编译
            cargo install cargo-xwin --locked
            rustup show

        - name: 安装 Node.js 与 pnpm
          script: |
            if ! command -v node &>/dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
              apt-get install -y nodejs
            fi
            if ! command -v pnpm &>/dev/null; then
              npm install -g pnpm
            fi
            node -v
            pnpm -v

        - name: 提取版本号
          script: |
            VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
            echo "版本号: $VERSION"
            echo "##[set-output VERSION=$VERSION]"
          exports:
            VERSION: APP_VERSION

        - name: 安装前端依赖
          script: |
            pnpm install

        - name: 交叉编译 Windows 应用 (exe + msi + nsis)
          script: |
            . "$HOME/.cargo/env"
            # 使用 cargo-xwin 交叉编译到 Windows x86_64
            pnpm tauri build --target x86_64-pc-windows-msvc --runner cargo-xwin
          timeout: 2h

        - name: 创建并推送 Tag
          script: |
            git config user.name "cnb-actions[bot]"
            git config user.email "cnb-actions[bot]@cnb.cool"
            TAG="v$APP_VERSION"
            if git rev-parse "$TAG" &>/dev/null; then
              echo "Tag $TAG 已存在，跳过创建"
            else
              git tag -a "$TAG" -m "Release $TAG"
              git push origin "$TAG"
              echo "已创建并推送 Tag: $TAG"
            fi

        - name: 创建 CNB Release
          script: |
            TAG="v$APP_VERSION"
            echo "正在创建 Release: Majdata Hub $TAG"
            RESPONSE=$(curl --silent --request POST \
              --url "https://api.cnb.cool/${CNB_REPO_SLUG}/-/releases" \
              --header 'Accept: application/vnd.cnb.api+json' \
              --header "Authorization: ${CNB_TOKEN}" \
              --header 'Content-Type: application/json' \
              --data "{
                \"body\": \"\",
                \"draft\": false,
                \"make_latest\": \"true\",
                \"name\": \"Majdata Hub ${TAG}\",
                \"prerelease\": false,
                \"tag_name\": \"${TAG}\",
                \"target_commitish\": \"main\"
              }")
            echo "Response: $RESPONSE"
            RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
            if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
              echo "Release 创建失败"
              exit 1
            fi
            echo "Release ID: $RELEASE_ID"
            echo "##[set-output RELEASE_ID=$RELEASE_ID]"
          exports:
            RELEASE_ID: CNB_RELEASE_ID

        - name: 上传构建产物到 Release
          script: |
            # Windows 交叉编译产物路径
            MSI_DIR="src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi"
            NSIS_DIR="src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis"

            upload_file() {
              local FILE="$1"
              [ -z "$FILE" ] || [ ! -f "$FILE" ] && return
              local ASSET_NAME
              ASSET_NAME=$(basename "$FILE")
              local SIZE
              SIZE=$(wc -c < "$FILE")
              echo "正在上传 $ASSET_NAME..."
              PAYLOAD=$(jq -n \
                --arg name "$ASSET_NAME" \
                --argjson size "$SIZE" \
                '{"asset_name":$name,"overwrite":true,"size":$size,"ttl":0}')
              curl --request POST \
                --url "https://api.cnb.cool/${CNB_REPO_SLUG}/-/releases/${CNB_RELEASE_ID}/asset-upload-url" \
                --header 'Accept: application/vnd.cnb.api+json' \
                --header "Authorization: ${CNB_TOKEN}" \
                --header 'Content-Type: application/json' \
                --data "$PAYLOAD"
              echo "已上传: $ASSET_NAME"
            }

            if [ -d "$MSI_DIR" ]; then
              for file in "$MSI_DIR"/*; do
                [ -f "$file" ] && upload_file "$file"
              done
            else
              echo "MSI 目录不存在，跳过"
            fi

            if [ -d "$NSIS_DIR" ]; then
              for file in "$NSIS_DIR"/*; do
                [ -f "$file" ] && upload_file "$file"
              done
            else
              echo "NSIS 目录不存在，跳过"
            fi

            echo "所有构建产物上传完毕"
